{% extends "base.html" %}

{% block title %}Dashboard Recepción{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reception-patients.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>Panel de Recepción</h2>
        {% if session.assigned_screen %}
        <div class="screen-info-banner">
            <i class="fas fa-tv"></i>
            <span>Pantalla asignada: <strong>{{ session.assigned_screen }}</strong></span>
            <a href="/screen/{{ session.assigned_screen }}" target="_blank" class="btn-view-screen">
                <i class="fas fa-external-link-alt"></i>
                Abrir Pantalla
            </a>
        </div>
        {% else %}
        <div class="screen-info-banner warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>No tienes pantalla asignada. Contacta al administrador.</span>
        </div>
        {% endif %}
    </div>

    <div class="dashboard-tabs">
        <button class="tab-btn active" onclick="switchTab('patients')">
            <i class="fas fa-users"></i>
            Pacientes
        </button>
        <button class="tab-btn" onclick="switchTab('doctors')">
            <i class="fas fa-user-md"></i>
            Doctores
        </button>
        <button class="tab-btn" onclick="switchTab('multimedia')">
            <i class="fas fa-photo-video"></i>
            Multimedia
        </button>
        {% if session.assigned_screen %}
        <button class="tab-btn" onclick="switchTab('screen')">
            <i class="fas fa-tv"></i>
            Ver Pantalla
        </button>
        {% endif %}
    </div>

    <!-- Tab: Pacientes (PRIMERO - Más importante) -->
    <div class="tab-content active" id="patients-tab">
        <div class="section-header">
            <h3>
                <i class="fas fa-users"></i>
                Pacientes en Espera
            </h3>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="btn-secondary" onclick="loadPatients()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
                <span id="lastUpdate" style="font-size: 13px; color: #6b7280;"></span>
            </div>
        </div>

        <div class="patients-list" id="patientsList">
            <div class="loading">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #667eea;"></i>
                <p>Cargando pacientes...</p>
            </div>
        </div>
    </div>

    <!-- Tab: Doctores -->
    <div class="tab-content" id="doctors-tab">
        <div class="section-header">
            <h3>
                <i class="fas fa-user-md"></i>
                Gestión de Doctores
            </h3>
            <button class="btn-primary" onclick="showCreateDoctorModal()">
                <i class="fas fa-plus"></i>
                Crear Doctor
            </button>
        </div>

        <div class="doctors-grid" id="doctorsGrid">
            <div class="loading">Cargando doctores...</div>
        </div>
    </div>

    <!-- Tab: Multimedia -->
    <div class="tab-content" id="multimedia-tab">
        <div class="section-header">
            <h3>
                <i class="fas fa-photo-video"></i>
                Contenido Multimedia
            </h3>
            <button class="btn-primary" onclick="showUploadMediaModal()">
                <i class="fas fa-upload"></i>
                Subir Archivo
            </button>
        </div>

        <div class="multimedia-grid" id="multimediaGrid">
            <div class="loading">Cargando multimedia...</div>
        </div>
    </div>

    <!-- Tab: Ver Pantalla -->
    {% if session.assigned_screen %}
    <div class="tab-content" id="screen-tab">
        <div class="section-header">
            <h3>
                <i class="fas fa-tv"></i>
                Vista de Pantalla {{ session.assigned_screen }}
            </h3>
            <div class="screen-actions">
                <a href="/screen/{{ session.assigned_screen }}" target="_blank" class="btn-primary">
                    <i class="fas fa-external-link-alt"></i>
                    Abrir en Nueva Ventana
                </a>
                <button class="btn-secondary" onclick="refreshScreenPreview()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>
        </div>

        <div class="screen-preview-wrapper">
            <iframe 
                id="screenPreviewFrame" 
                src="/screen/{{ session.assigned_screen }}" 
                frameborder="0"
                style="width: 100%; height: 70vh; border: 2px solid #e5e7eb; border-radius: 8px;"
            ></iframe>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Crear Doctor -->
<div class="modal" id="createDoctorModal">
    <div class="modal-content">
        <h2>
            <i class="fas fa-user-md"></i>
            Crear Doctor
        </h2>
        <form id="createDoctorForm" onsubmit="createDoctor(event)">
            <div class="form-group">
                <label>
                    <i class="fas fa-id-badge"></i>
                    Nombre del Doctor
                </label>
                <input 
                    type="text" 
                    name="name" 
                    placeholder="Dr. Juan Pérez" 
                    required 
                    autofocus
                >
            </div>
            <div class="form-group">
                <label>
                    <i class="fas fa-tag"></i>
                    Tipo de Atención
                </label>
                <select name="type" required>
                    <option value="">-- Selecciona un tipo --</option>
                    <option value="I">I - Información</option>
                    <option value="C">C - Consulta</option>
                </select>
                <small style="display: block; margin-top: 8px; color: #6b7280; font-size: 13px;">
                    <strong>I:</strong> Para información general<br>
                    <strong>C:</strong> Para consultas médicas
                </small>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i>
                    Crear Doctor
                </button>
                <button type="button" class="btn-secondary" onclick="hideModal('createDoctorModal')">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Subir Multimedia -->
<div class="modal" id="uploadMediaModal">
    <div class="modal-content">
        <h2>
            <i class="fas fa-upload"></i>
            Subir Archivo Multimedia
        </h2>
        <form id="uploadMediaForm" onsubmit="uploadMedia(event)" enctype="multipart/form-data">
            <div class="form-group">
                <label>
                    <i class="fas fa-list"></i>
                    Tipo de Archivo
                </label>
                <select name="type" id="mediaType" required onchange="updateFileAccept()">
                    <option value="">-- Selecciona el tipo --</option>
                    <option value="image">Imagen (JPG, PNG, GIF)</option>
                    <option value="video">Video (MP4, WebM)</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <i class="fas fa-file"></i>
                    Seleccionar Archivo
                </label>
                <input 
                    type="file" 
                    name="file" 
                    id="mediaFile"
                    accept="image/*,video/*" 
                    required
                >
                <small style="display: block; margin-top: 8px; color: #6b7280; font-size: 13px;">
                    <strong>Imágenes:</strong> .jpg, .png, .gif, .webp<br>
                    <strong>Videos:</strong> .mp4, .webm, .ogg
                </small>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Subir Archivo
                </button>
                <button type="button" class="btn-secondary" onclick="hideModal('uploadMediaModal')">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* Estilos del banner de pantalla */
.screen-info-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border-left: 4px solid #667eea;
    border-radius: 8px;
    margin-bottom: 16px;
}

.screen-info-banner.warning {
    background: linear-gradient(135deg, #f59e0b15 0%, #ef444415 100%);
    border-left-color: #f59e0b;
}

.screen-info-banner i {
    color: #667eea;
    font-size: 20px;
}

.screen-info-banner.warning i {
    color: #f59e0b;
}

.screen-info-banner span {
    flex: 1;
    font-size: 14px;
    color: #1f2937;
}

.btn-view-screen {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-view-screen:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.screen-actions {
    display: flex;
    gap: 12px;
}

.screen-preview-wrapper {
    margin-top: 16px;
}

.dashboard-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 2px solid #e5e7eb;
    overflow-x: auto;
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #6b7280;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.tab-btn i {
    font-size: 14px;
}

.tab-btn:hover {
    color: #667eea;
}

.tab-btn.active {
    color: #667eea;
    border-bottom-color: #667eea;
}

.section-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header h3 i {
    color: #667eea;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.loading i {
    display: block;
    margin-bottom: 12px;
}
</style>

<script>
function updateFileAccept() {
    const typeSelect = document.getElementById('mediaType');
    const fileInput = document.getElementById('mediaFile');
    
    if (typeSelect.value === 'image') {
        fileInput.accept = 'image/*';
    } else if (typeSelect.value === 'video') {
        fileInput.accept = 'video/*';
    }
}

function refreshScreenPreview() {
    const iframe = document.getElementById('screenPreviewFrame');
    if (iframe) {
        iframe.src = iframe.src;
        showFlashMessage('Vista previa actualizada', 'success');
    }
}

// Actualizar timestamp de última actualización
function updateTimestamp() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-CO', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const elem = document.getElementById('lastUpdate');
    if (elem) {
        elem.textContent = `Última actualización: ${timeStr}`;
    }
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/reception.js') }}"></script>
{% endblock %}